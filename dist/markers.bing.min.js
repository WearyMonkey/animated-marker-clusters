!function t(e,n,o){function i(r,_){if(!n[r]){if(!e[r]){var a="function"==typeof require&&require;if(!_&&a)return a(r,!0);if(s)return s(r,!0);var l=new Error("Cannot find module '"+r+"'");throw l.code="MODULE_NOT_FOUND",l}var u=n[r]={exports:{}};e[r][0].call(u.exports,function(t){var n=e[r][1][t];return i(n?n:t)},u,u.exports,t,e,n,o)}return n[r].exports}for(var s="function"==typeof require&&require,r=0;r<o.length;r++)i(o[r]);return i}({1:[function(t){window.wm={Markers:t("./../markers.js"),Point:t("./../point.js"),Line:t("./../line.js"),mapConnectors:{bing:t("./../map-connectors/bing.js")},defaultMapConnector:"bing"}},{"./../line.js":4,"./../map-connectors/bing.js":5,"./../markers.js":6,"./../point.js":7}],2:[function(t,e){function n(t){var e,o,i,s,r=Number.MAX_VALUE;if(!t._bestPoint)if(o=t._parent&&n(t._parent),o&&null!=t._points[o._id])t._bestPoint=o;else for(e in t._points)t._points.hasOwnProperty(e)&&(s=t._points[e],i=u(t,s,t._center),r>i&&(t._bestPoint=s,r=i));return t._bestPoint}function o(t,e){var n,o,s,r,_={},a=t._zoom+t._zoomRange;if(!(a>t._geo.maxZoom)){for(n=0;n<e.length;++n)s=e[n],o=i(t,s._latLng,t._children),_[o._id]=_[o._id]||[],_[o._id].push(s);for(n=0;n<t._children;++n)o=t._children[n],r=_[o._id],r&&o.addPoints(r)}}function i(t,e,n){return _(t,e,n,!0)}function s(t,e,n){var o,a,u,c,h=[];if(!t._children.length){for(o in t._points)t._points.hasOwnProperty(o)&&(u=new d(t,t._geo.maxZoom,1,t._geo,t._settings),u.addPoints([t._points[o]]),t._children.push(u));if(0==--n)return!0}for(t._children.length<3?c=t._children:(c=[_(t,t._center,t._children)],c.push(_(t,c[0]._center,t._children))),o=0;o<c.length;++o)u=new d(t,e,n,t._geo,t._settings),h.push(u),u._center=t._geo.getBoundsCenter(c[o]._bounds);for(o=0;o<t._children.length;++o){var p=t._children[o];u=i(t,t._geo.getBoundsCenter(p._bounds),h),u._children.push(p)}for(t._children=h,t._pointToChild={},o=0;o<h.length;++o){for(u=h[o],a=0;a<u._children.length;++a)r(t,u,u._children[a]);u._center=t._geo.getBoundsCenter(u._bounds),u._zoomRange=l(u),u._zoomRange<n&&s(u,u._zoom+u._zoomRange,n-u._zoomRange)}return!0}function r(t,e,n){e._bounds=t._geo.extendBounds(e._bounds,[n._bounds]),n._parent=e;for(var o in n._points)if(n._points.hasOwnProperty(o)){var i=n._points[o];e._points[i._id]=i,e._pointToChild[i._id]=n,t._pointToChild[i._id]=e}}function _(t,e,n,o){for(var i,s=o?Number.MAX_VALUE:0,r=0;r<n.length;++r){var _=n[r],a=u(t,e,_._center);(o&&s>a||!o&&a>s)&&(s=a,i=_)}return i}function a(t){if(!t._parent)return!1;var e,n=t._parent._children,o=t._zoom;for(e=0;e<n.length;++e)n[e]==t&&n.splice(e,1);for(e=0;e<t._children.length;++e){var i=t._children[e];i._zoomRange+=i._zoom-o,i._zoom=o,i._parent=t._parent,n.push(i)}return!0}function l(t){var e,n=t._geo.getBoundsSpan(t._bounds),o=t._zoom,i=t._zoom+t._zoomRange-1;for(e=n._lat>n._lng?n._lat:n._lng;i>o&&t._settings.zoomBoxes[i].max<e;)i--;return i-o+1}function u(t,e,n){var o=null!=e._lat?e:t._geo.getLatLng(e._latLng||e),i=null!=n._lat?n:t._geo.getLatLng(n._latLng||n);return c(o._lat,o._lng,i._lat,i._lng)}function c(t,e,n,o){var i=t-n,s=e-o;return i*i+s*s}var h=t("./utils.js"),p=1,d=function(t,e,n,o,i){this._parent=t,this._settings=i,this._geo=o,this._id=p++,this._zoom=e,this._zoomRange=n,this._children=[],this._points={},this._pointToChild={},this._connections=[],this._bounds=o.createBounds(),this._center=o.createLatLng(0,0),this._expandDepth=0};h.extend(d.prototype,{getBounds:function(){return this._bounds},getCenter:function(){return this._center},getDisplayCenter:function(){return n(this)._latLng},getPoints:function(){var t=[];for(var e in this._points)this._points.hasOwnProperty(e)&&t.push(this._points[e]);return t},getMarker:function(){return this._marker},getParent:function(){return this._parent},getExpandDepth:function(){return this._expandDepth},getZoomRange:function(){return{from:this._zoom,to:this._zoom+this._zoomRange-1}},removePoints:function(t){var e,n=!1;for(e=0;e<t.length;++e){var o=t[e];this._points[o._id]&&(delete this._points[o._id],n=!0,this._parent&&delete this._parent._pointToChild[o._id])}if(n){for(e=0;e<this._children.length;++e){var i=this._children[e];i.removePoints(t)||(this._children.splice(e,1),--e)}this._bestPoint=null,this._bounds=this._geo.createBounds();var s=[];for(var r in this._points)this._points.hasOwnProperty(r)&&s.push(this._points[r]._latLng);return this._bounds=this._geo.extendBounds(this._bounds,s),!!s.length}return!0},addPoints:function(t){var e,n=!1,i=[];for(e=0;e<t.length;++e){var r=t[e];this._points[r._id]||(this._points[r._id]=r,i.push(r._latLng),this._parent&&(this._parent._pointToChild[r._id]=this),n=!0)}if(this._bounds=this._geo.extendBounds(this._bounds,i),n){this._bestPoint=null,this._center=this._geo.getBoundsCenter(this._bounds),o(this,t);var _=this._zoomRange;this._zoomRange=l(this),this._zoomRange<_&&s(this,this._zoom+this._zoomRange,_-this._zoomRange),0==this._zoomRange&&a(this)}},addLine:function(t){for(var e=this._pointToChild,n={},o=1;o<t._points.length;++o){var i=t._points[o]._id,s=t._points[o-1]._id,r=e[i],_=e[s];r&&_&&r!=_&&this._connections.push({_id:p++,_pointId1:i,_pointId2:s,_cluster1:e[i],_cluster2:e[s],_line:t}),r&&(n[r._id]||(n[r._id]=!0,r.addLine(t)))}},removeLine:function(t){for(var e={},n=this._connections,o=0;o<n.length;++o){var i=n[o];if(i._line==t){n.splice(o--,1);var s=this._pointToChild[i._pointId1],r=this._pointToChild[i._pointId2];e[s._id]||s.removeLine(t),e[r._id]||r.removeLine(t),e[s._id]=!0,e[r._id]=!0}}}}),e.exports=d},{"./utils.js":8}],3:[function(t){function e(t,o,i,s,r,_,a,l,u,c,h,p){s=Math.max(null!=t[u]?t[u]:t[c],s-1,0),i=Math.max(null!=t[c]?t[c]:t[u],i-1,0);var d=t._zoom+t._zoomRange-1>=l&&0==s,g=!t._children.length||-1==t._expandDepth;if(g||d)h.push({cluster:t,parent:o});else{t._zoom+t._zoomRange-1>=a&&0==i&&(o=t),p&&n(t,o,i,s,a,l,u,c,p);for(var f=0;f<t._children.length;++f){var m=t._children[f];(_&&m._points[r]||!_&&t._geo.boundsIntersects(m._bounds,r))&&e(m,o,i,s,r,_,a,l,u,c,h,p)}}return h}function n(t,n,o,i,s,r,_,a,l){for(var u=0;u<t._connections.length;u++){var c=t._connections[u];c._displayCluster1=e(c._cluster1,n,o,i,c._pointId1,!0,s,r,_,a,[])[0],c._displayCluster2=e(c._cluster2,n,o,i,c._pointId2,!0,s,r,_,a,[])[0],l.push(c)}}var o=t("./utils.js"),i=t("./cluster.js");o.extend(i.prototype,{getContainedClustersAndConnections:function(t,n,o,i,s){var r=[],_=[];return this._geo.boundsIntersects(this._bounds,t)&&e(this,null,0,0,t,!1,o,n,i,s,r,_),{clusters:r,connections:_}}})},{"./cluster.js":2,"./utils.js":8}],4:[function(t,e){function n(t){for(var e=[],n=0;n<t.length;++n)e.push(o(t[n]));return e}var o=t("./point"),i=t("./utils.js"),s=1,r=function(t,e){return t instanceof r?t:this instanceof r?(this._id=s++,this._points=n(t),this._data=e,void 0):new r(t,e)};i.extend(r.prototype,{getPoints:function(){return this._points},getData:function(){return this._data}}),e.exports=r},{"./point":7,"./utils.js":8}],5:[function(t,e){e.exports={maxZoom:20,createMarker:function(){return new Microsoft.Maps.Pushpin},createPolyline:function(){return new Microsoft.Maps.Polyline([])},createLatLng:function(t,e){return new Microsoft.Maps.Location(t,e)},getLatLng:function(t){return{_lat:t.latitude,_lng:t.longitude}},getMarkerPosition:function(t){return t.getLocation()},setMarkerPosition:function(t,e){t.setLocation(e)},getPolylinePath:function(t){return t.getLocations().slice()},setPolylinePath:function(t,e){t.setLocations(e)},showMarker:function(t,e){t.entities.push(e)},showPolyline:function(t,e){t.entities.push(e)},hideMarker:function(t,e){t.entities.remove(e)},hidePolyline:function(t,e){t.entities.remove(e)},createBounds:function(){return new Microsoft.Maps.LocationRect},extendBounds:function(t,e){for(var n=t.center?[t.getNorthwest(),t.getSoutheast()]:[],o=0;o<e.length;++o){var i=e[o];i instanceof Microsoft.Maps.LocationRect&&i.center?(n.push(i.getNorthwest()),n.push(i.getSoutheast())):n.push(i)}return Microsoft.Maps.LocationRect.fromLocations(n)},getBoundsCenter:function(t){return t.center},boundsIntersects:function(t,e){return t.center&&e.center?t.intersects(e):!1},getBoundsSpan:function(t){return{_lat:t.height||0,_lng:t.width||0}},onMapBoundsChange:function(t,e){Microsoft.Maps.Events.addHandler(t,"viewchangeend",e)},off:function(t){Microsoft.Maps.Events.removeHandler(t)},getMapZoom:function(t){return t.getZoom()},getMapBounds:function(t){return t.getBounds()},onMarkerClicked:function(t,e){return Microsoft.Maps.Events.addHandler(t,"click",e)}}},{}],6:[function(t,e){function n(t,e,n){for(var o=new RegExp("^"+e+"(\\..*)?$"),i=0;i<t._listeners.length;++i){var s=t._listeners[i];s.event.match(o)&&s.callback(v.extend({markers:t},n))}}function o(t,e,o){return e._keepKey=t._keepKey,t._visibleClusters.push(e),e._marker||(e._marker=t._options.createMarker(e),e._clickListener=t._geo.onMarkerClicked(e._marker,function(){n(t,"clusterClicked",{cluster:e})})),e._dLat=e._dLng=null,t._geo.setMarkerPosition(e._marker,o||e.getDisplayCenter()),e._visible||(t._geo.showMarker(t._map,e._marker),e._visible=!0,n(t,"clusterShown",{cluster:e})),e._marker}function i(t,e){return e._keepKey=t._keepKey,t._visibleConnections.push(e),e._polyline=e._polyline||t._options.createPolyline(e._line),t._geo.setPolylinePath(e._polyline,[e._displayCluster1.cluster._marker?t._geo.getMarkerPosition(e._displayCluster1.cluster._marker):e._displayCluster1.cluster.getDisplayCenter(),e._displayCluster2.cluster._marker?t._geo.getMarkerPosition(e._displayCluster2.cluster._marker):e._displayCluster2.cluster.getDisplayCenter()]),e._visible||(t._geo.showPolyline(t._map,e._polyline),e._visible=!0,n(t,"lineShown",{line:e._line})),e._polyline}function s(t,e,o){e._marker&&(t._geo.hideMarker(t._map,e._marker),e._visible=!1,n(t,"clusterHidden",{cluster:e}),o&&(t._geo.off(e._clickListener),delete e._marker))}function r(t,e,o){e._polyline&&(t._geo.hidePolyline(t._map,e._polyline),e._visible=!1,n(t,"lineHidden",{line:e._line}),o&&delete e._polyline)}function _(t){var e,n=t._clusterRoot.getContainedClustersAndConnections(g(t),t._zoom,t._prevZoom,"_expandDepth","_oldExpandDepth");for(e=0;e<n.clusters.length;++e)o(t,n.clusters[e].cluster);for(e=0;e<n.connections.length;++e)i(t,n.connections[e])}function a(t){var e=t._clusterRoot.getContainedClustersAndConnections(g(t),t._zoom,t._prevZoom,"_expandDepth","_oldExpandDepth");u(t,e,!1)}function l(t){var e=t._clusterRoot.getContainedClustersAndConnections(g(t),t._prevZoom,t._zoom,"_oldExpandDepth","_expandDepth");u(t,e,!0)}function u(t,e,n){var o;for(o=0;o<e.clusters.length;++o)c(t,e.clusters[o],n);for(o=0;o<e.connections.length;o++){var s=e.connections[o];c(t,s._displayCluster1,n),c(t,s._displayCluster2,n),i(t,s)}h(t)}function c(t,e,n){var i=e.parent,s=e.cluster;if(s._keepKey!=t._keepKey)if(i){var r=n?i:s,_=n?s:i,a=t._geo.getLatLng(r.getDisplayCenter()),l=t._geo.getLatLng(_.getDisplayCenter());o(t,s,_.getDisplayCenter()),s._dLat=(a._lat-l._lat)/t._options.animationSteps,s._dLng=(a._lng-l._lng)/t._options.animationSteps}else o(t,s)}function h(t){function e(){if(o++<t._options.animationSteps){for(n=0;n<t._visibleClusters.length;++n){var s=t._visibleClusters[n],r=t._visibleClusters[n]._marker;if(s._dLat||s._dLng){var _=p(t,t._geo.getMarkerPosition(r),s);t._geo.setMarkerPosition(r,_)}}for(n=0;n<t._visibleConnections.length;++n){var a=t._visibleConnections[n],l=a._displayCluster1.cluster,u=a._displayCluster2.cluster;if(l._dLat||u._dLat||l._dLng||u._dLng){var c=a._polyline,h=t._geo.getPolylinePath(c);h[0]=p(t,h[0],l),h[1]=p(t,h[1],u),t._geo.setPolylinePath(c,h)}}t._timeout=setTimeout(e,i)}else d(t)}var n,o=0,i=t._options.animationInterval;e()}function p(t,e,n){if(!n||!n._dLat&&!n._dLng)return e;var o=t._geo.getLatLng(e);return t._geo.createLatLng(o._lat+n._dLat,o._lng+n._dLng)}function d(t,e){var n=t._visibleClusters,o=t._visibleConnections;t._keepKey=(t._keepKey+1)%3735928559,t._visibleClusters=[],t._visibleConnections=[],clearTimeout(t._timeout),e===!1||t._prevZoom<t._zoom?a(t):e===!0||t._prevZoom>t._zoom?l(t):_(t),setTimeout(function(){var e;for(e=0;e<n.length;++e){var i=n[e];i._keepKey!=t._keepKey&&s(t,i)}for(e=0;e<o.length;++e){var _=o[e];_._keepKey!=t._keepKey&&r(t,_)}},0)}function g(t){return t._geo.getMapBounds(t._map)}function f(t){for(var e=[],n=84.375,o=112.6,i=1,s=0;s<=t.maxZoom;s++)e[s]={min:n/i,max:o/i},i<<=1;return e}var m=t("./cluster.js");t("./cluster_search.js");var v=t("./utils.js"),C=t("./point.js"),y=t("./line.js"),L=function(t,e){var n=this;this._visibleClusters=[],this._visibleConnections=[],this._keepKey=0,this._map=t,this._zoom=this._prevZoom=this._map.getZoom(),this._geo=e.mapConnector||wm.defaultMapConnector&&wm.mapConnectors&&wm.mapConnectors[wm.defaultMapConnector],this._options=v.extend({animationSteps:30,animationInterval:16,createMarker:this._geo.createMarker,createPolyline:this._geo.createPolyline},e),this._clusterRoot=new m(null,0,this._geo.maxZoom+1,this._geo,{zoomBoxes:f(this._geo)}),this._listeners=[],d(this),this._boundsListener=n._geo.onMapBoundsChange(t,function(){var e=n._geo.getMapZoom(t);0>e||e>n._geo.maxZoom||(n._prevZoom=n._zoom,n._zoom=e,d(n),n._prevZoom=e,n._prevBounds=n._geo.getMapBounds(t))})};v.extend(L.prototype,{on:function(t,e){return this._listeners.push({event:t,callback:e}),this},off:function(t,e){for(var n=0;n<this._listeners.length;++n){var o=this._listeners[n];o.event!=t||e&&e!=o.callback||this._listeners.splice(n--,1)}return this},addLine:function(t,e){return t=y(t),e&&e.addPoints===!0&&this._clusterRoot.addPoints(t._points),this._clusterRoot.addLine(t),d(this),t},removeLine:function(t,e){this._clusterRoot.removeLine(t),e&&e.removePoints===!0&&this._clusterRoot.removePoints(t._points),d(this)},addPoint:function(t){return t=C(t),this._clusterRoot.addPoints([t]),d(this),t},removePoint:function(t){this._clusterRoot.removePoints([t]),d(this)},addPoints:function(t){for(var e=[],n=0;n<t.length;++n)e.push(C(t[n]));return this._clusterRoot.addPoint(e),d(this),e},removePoints:function(t){this._clusterRoot.removePoints(t),d(this)},destroy:function(){for(var t=0;t<this._visibleClusters.length;++t)s(this,this._visibleClusters[t],!0);for(t=0;t<this._visibleConnections.length;++t)r(this,this._visibleConnections[t],!0);this._boundsListener&&this._geo.offMapsBoundChange(this._boundsListener)},setClusterState:function(t,e){if("normal"==e)for(;t&&0==t._expandDepth;)t=t._parent;if(t){var n,o=t._expandDepth;t._oldExpandDepth=o,"normal"==e?(t._expandDepth=0,o>0?n=!0:0>o&&(n=!1)):"collapsed"==e?(t._expandDepth=-1,n=!0):"expanded"==e&&(t._expandDepth=1,n=!1),d(this,n),delete t._oldExpandDepth}}}),e.exports=L},{"./cluster.js":2,"./cluster_search.js":3,"./line.js":4,"./point.js":7,"./utils.js":8}],7:[function(t,e){var n=t("./utils.js"),o=1,i=function(t,e){return t instanceof i?t:this instanceof i?(this._id=o++,this._latLng=t,this._data=e,void 0):new i(t,e)};n.extend(i.prototype,{getLatLng:function(){return this._latLng},getData:function(){return this._data}}),e.exports=i},{"./utils.js":8}],8:[function(t,e){e.exports={extend:function(t){for(var e=1;e<arguments.length;++e){var n=arguments[e];for(var o in n)n.hasOwnProperty(o)&&(t[o]=n[o])}return t}}},{}]},{},[1]);